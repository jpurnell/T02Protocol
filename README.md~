# T02Protocol Swift Package

Platform-independent Swift implementation of the Phomemo T02 thermal printer protocol.

## üéâ **NEW**: Direct BLE Printing on macOS!

You can now print directly to your T02 printer from macOS using Bluetooth Low Energy!

**üìñ [See Quick Start Guide](../../QUICK_START_T02.md) for step-by-step instructions**

```bash
# Simple printing
./t02-print my_image.png

# Or use the tool directly
swift run T02PrintTool bt my_image.png
```

## Features

- ‚úÖ Modern Swift 5.9+ with Swift Testing
- ‚úÖ Cross-platform (macOS 13+, iOS 16+)
- ‚úÖ Complete T02 protocol implementation
- ‚úÖ **BLE printing via CoreBluetooth** (macOS)
- ‚úÖ Image conversion and processing
- ‚úÖ Type-safe API with enums
- ‚úÖ Comprehensive test suite
- ‚úÖ Byte-for-byte compatible with Python reference implementation
- ‚úÖ Command-line tool for testing and printing

## Requirements

- Swift 5.9+
- Xcode 15+ (for Swift Testing)
- macOS 13+ or iOS 16+

## Installation

### Swift Package Manager

Add to your `Package.swift`:

```swift
dependencies: [
    .package(url: "https://github.com/yourusername/phomemo-tools", from: "1.0.0")
]
```

Or add via Xcode: File ‚Üí Add Package Dependencies...

### Local Development

```bash
cd shared/swift
swift build
swift test
```

## Quick Start: Printing to T02

### Easy Mode (Recommended)

Use the helper script:

```bash
./t02-print image.png
```

The script will:
1. Remind you to power cycle the printer
2. Wait for confirmation
3. Print your image

### Direct Tool Usage

For more control, use the tool directly:

```bash
# Print an image
swift run T02PrintTool bt image.png

# Print with custom feed
swift run T02PrintTool bt image.png 6

# Create a test image
swift run T02PrintTool create test.png

# Debug protocol output
swift run T02PrintTool debug image.png
```

**Important**: The T02 must be freshly powered on (BLE advertising) to connect.

üìñ **Full instructions**: See [QUICK_START_T02.md](../../QUICK_START_T02.md)

## Library Usage

### Basic Usage

```swift
import T02Protocol

#if canImport(UIKit)
import UIKit

let protocol = T02Protocol()

// Load an image
let image = UIImage(named: "label")!

// Generate print data
let printData = try protocol.generatePrintData(from: image, feedLines: 4)

// Send to printer (via CoreBluetooth or USB)
bluetoothManager.send(data: printData)
#endif
```

### Custom Feed Lines

```swift
// Use custom paper feed
let printData = try protocol.generatePrintData(from: image, feedLines: 10)
```

### Manual Command Generation

```swift
let protocol = T02Protocol()

// Individual commands
let initCmd = protocol.cmdInitPrinter()
let justifyCmd = protocol.cmdSetJustification(.center)
let feedCmd = try protocol.cmdFeedLines(4)
let rasterHeader = protocol.cmdRasterHeader(widthBytes: 48, lines: 100, mode: .normal)

// Combine commands
var data = Data()
data.append(initCmd)
data.append(justifyCmd)
// ... add image data ...
data.append(feedCmd)
```

## API Reference

### T02Protocol

#### Constants
```swift
static let widthDots: Int        // 384 (50mm at 203 DPI)
static let widthBytes: Int       // 48 (384 / 8)
static let dpi: Int              // 203
static let maxLinesPerBlock: Int // 255 (protocol limit)
static let defaultFeedLines: Int // 4 (T02 default)
```

#### Methods

**`init()`**
Create a new protocol instance.

**`convertImage(_ image: PlatformImage) throws -> CGImage`**
Convert platform image to T02-compatible format (384px wide, 1-bit monochrome).

**`generatePrintData(from image: PlatformImage, feedLines: Int?) throws -> Data`**
Generate complete print data stream from image.

**`cmdInitPrinter() -> Data`**
Generate ESC @ initialization command.

**`cmdSetJustification(_ position: Justification) -> Data`**
Generate ESC a command.

**`cmdFeedLines(_ lines: Int) throws -> Data`**
Generate ESC d command to feed paper.

**`cmdRasterHeader(widthBytes: Int, lines: Int, mode: PrintMode) -> Data`**
Generate GS v 0 raster image header.

#### Enums

**`Justification`**
- `.left` - Left align
- `.center` - Center align
- `.right` - Right align

**`PrintMode`**
- `.normal` - Standard printing
- `.doubleWidth` - 2x width
- `.doubleHeight` - 2x height
- `.quadruple` - 4x size

## Testing

This package uses **Swift Testing** (not XCTest) for a modern testing experience.

### Run All Tests

```bash
swift test
```

### Run Specific Tests

```bash
# Run a specific suite
swift test --filter T02ProtocolConstantsTests

# Run a specific test
swift test --filter "printerWidthDots"

# Run integration tests only
swift test --filter .integration
```

### Test Structure

```
Tests/
‚îî‚îÄ‚îÄ T02ProtocolTests/
    ‚îú‚îÄ‚îÄ T02ProtocolTests.swift   # Main test suite
    ‚îú‚îÄ‚îÄ Fixtures/                # Test images
    ‚îÇ   ‚îú‚îÄ‚îÄ solid_black.png
    ‚îÇ   ‚îú‚îÄ‚îÄ solid_white.png
    ‚îÇ   ‚îú‚îÄ‚îÄ checkerboard.png
    ‚îÇ   ‚îú‚îÄ‚îÄ single_line.png
    ‚îÇ   ‚îú‚îÄ‚îÄ vertical_stripes.png
    ‚îÇ   ‚îî‚îÄ‚îÄ large_image.png
    ‚îî‚îÄ‚îÄ GenerateFixtures.swift   # Fixture generator
```

### Test Coverage

- **Constants**: 5 tests
- **Commands**: 9 tests
- **Image Conversion**: 6 tests
- **Full Protocol**: 3 integration tests
- **Edge Cases**: 4 tests

## Protocol Details

### ESC/POS Command Set

```
ESC @ (0x1b 0x40)            - Initialize printer
ESC a n (0x1b 0x61 n)        - Set justification (0/1/2)
ESC d n (0x1b 0x64 n)        - Feed n lines
GS v 0 (0x1d 0x76 0x30 0x00) - Raster image
```

### Image Processing Pipeline

```
Input Image (any format/size)
    ‚Üì
Resize to 384px wide (maintain aspect ratio)
    ‚Üì
Convert to grayscale
    ‚Üì
Invert colors (thermal printer requirement)
    ‚Üì
Convert to 1-bit monochrome
    ‚Üì
Pack to bytes (48 bytes per line)
    ‚Üì
Split into 255-line blocks
    ‚Üì
Generate protocol commands
    ‚Üì
Output: Complete print data
```

### Protocol Structure

```
Header:
  ESC @ (init)
  ESC a 1 (center justify)

Body (repeat for each block):
  GS v 0 (raster header)
    - mode: 0 (normal)
    - width: 48 bytes (384 dots)
    - lines: 1-255
  [bitmap data: 48 √ó lines bytes]

Footer:
  ESC d N (feed N lines)
```

## Example: iOS Printing App

```swift
import SwiftUI
import T02Protocol
import CoreBluetooth

struct ContentView: View {
    @StateObject var bluetoothManager = T02BluetoothManager()
    @State var selectedImage: UIImage?

    var body: some View {
        VStack {
            if let image = selectedImage {
                Image(uiImage: image)
                    .resizable()
                    .scaledToFit()

                Button("Print to T02") {
                    printImage(image)
                }
            } else {
                Text("Select an image to print")
            }
        }
    }

    func printImage(_ image: UIImage) {
        let protocol = T02Protocol()

        do {
            let printData = try protocol.generatePrintData(from: image, feedLines: 4)
            bluetoothManager.send(data: printData)
        } catch {
            print("Print failed: \(error)")
        }
    }
}
```

## Platform Support

### macOS
- CoreGraphics for image processing
- AppKit (NSImage) for image handling
- IOBluetooth for printer communication

### iOS/iPadOS
- CoreGraphics for image processing
- UIKit (UIImage) for image handling
- CoreBluetooth for printer communication

## Development

### Test-Driven Development

This package was developed using TDD:

1. ‚úÖ Tests written first using Swift Testing
2. ‚è≥ Implementation driven by tests
3. ‚è≥ Refactor while keeping tests green

### Current Status

```bash
$ swift test
...
‚úó Tests not yet implemented (TDD phase 1 complete)
```

**Next Steps:**
1. Implement constants
2. Implement command methods
3. Implement image conversion
4. Implement full protocol generation
5. All tests pass ‚úì

## Compatibility

- **Swift Version**: 5.9+
- **Platforms**: macOS 13+, iOS 16+
- **Testing**: Swift Testing (not XCTest)
- **Python Compatibility**: Byte-for-byte compatible with reference implementation

## Related Projects

- **Python Reference**: `shared/python/t02_protocol.py`
- **CUPS Driver**: `cups/filter/rastertopm02_t02.py` (Linux)
- **macOS Backend**: `macos/backend/phomemo_t02.py` (planned)
- **iOS App**: `ios/T02Print/` (planned)

## License

GNU General Public License v3.0 - See LICENSE file

## Contributing

When implementing new features:
1. Write tests first using Swift Testing `@Test` macro
2. Run tests to see them fail
3. Implement feature
4. Run tests to see them pass
5. Refactor

Ensure byte-for-byte compatibility with Python reference implementation.

## Support

- **Printer**: Phomemo T02 only
- **Width**: 50mm (384 dots at 203 DPI)
- **Connection**: Bluetooth (device name: "T02")

For M02/M110/M220 support, see other protocol implementations.

## Changelog

### 1.0.0 (In Development)
- Initial Swift port
- Swift Testing test suite
- TDD implementation in progress
- Cross-platform support (macOS/iOS)
